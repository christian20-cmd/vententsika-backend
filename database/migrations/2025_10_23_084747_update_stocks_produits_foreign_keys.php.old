<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    public function up()
    {
        // 1. D'abord, supprimer la contrainte existante de produits vers stocks
        Schema::table('produits', function (Blueprint $table) {
            if (DB::getDriverName() !== 'sqlite') {
                $table->dropForeign(['idStock']);
            }
        });

        // 2. Ensuite, supprimer l'ancienne contrainte de stocks vers produits si elle existe
        Schema::table('stocks', function (Blueprint $table) {
            if (DB::getDriverName() !== 'sqlite') {
                try {
                    $table->dropForeign(['idProduit']);
                } catch (\Exception $e) {
                    // La contrainte n'existe peut-être pas encore
                }
            }
        });

        // 3. Recréer la contrainte de stocks vers produits
        Schema::table('stocks', function (Blueprint $table) {
            $table->foreign('idProduit')
                  ->references('idProduit')
                  ->on('produits')
                  ->onDelete('cascade');
        });

        // 4. Recréer la contrainte de produits vers stocks avec SET NULL
        Schema::table('produits', function (Blueprint $table) {
            $table->foreign('idStock')
                  ->references('idStock')
                  ->on('stocks')
                  ->onDelete('set null');
        });
    }

    public function down()
    {
        // Pour rollback
        Schema::table('produits', function (Blueprint $table) {
            if (DB::getDriverName() !== 'sqlite') {
                $table->dropForeign(['idStock']);
            }
        });

        Schema::table('stocks', function (Blueprint $table) {
            if (DB::getDriverName() !== 'sqlite') {
                $table->dropForeign(['idProduit']);
            }
        });

        // Remettre la configuration originale
        Schema::table('produits', function (Blueprint $table) {
            $table->foreign('idStock')
                  ->references('idStock')
                  ->on('stocks')
                  ->onDelete('cascade');
        });
    }
};
